# í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„í¬íŠ¸
import streamlit as st  # ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ êµ¬ì¶•ì„ ìœ„í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬
from langchain_community.document_loaders import PyPDFLoader  # PDF íŒŒì¼ì„ ë¡œë“œí•˜ê³  í…ìŠ¤íŠ¸ë¥¼ ì¶”ì¶œí•˜ëŠ” ë„êµ¬
from langchain.text_splitter import RecursiveCharacterTextSplitter  # ê¸´ í…ìŠ¤íŠ¸ë¥¼ ì‘ì€ ì²­í¬ë¡œ ë¶„í• í•˜ëŠ” ë„êµ¬
from langchain_community.embeddings import OllamaEmbeddings  # Ollamaë¥¼ ì‚¬ìš©í•œ í…ìŠ¤íŠ¸ ì„ë² ë”© ìƒì„±
from langchain_community.vectorstores import Chroma  # ë²¡í„° ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥ì†Œ
from langchain_community.llms import Ollama  # Ollama LLM(ëŒ€ê·œëª¨ ì–¸ì–´ ëª¨ë¸) ì¸í„°í˜ì´ìŠ¤
from langchain.chains import RetrievalQA  # ì§ˆì˜ì‘ë‹µ ì²´ì¸ êµ¬í˜„
import tempfile  # ì„ì‹œ íŒŒì¼ ì²˜ë¦¬
import os  # íŒŒì¼ ì‹œìŠ¤í…œ ì‘ì—…
import time  # ì‹œê°„ ì¸¡ì •ì„ ìœ„í•œ ëª¨ë“ˆ ì¶”ê°€

# Streamlit í˜ì´ì§€ ê¸°ë³¸ ì„¤ì •
st.set_page_config(
    page_title="AI ë…¼ë¬¸ ë¶„ì„ê¸°",  # ë¸Œë¼ìš°ì € íƒ­ì— í‘œì‹œë  ì œëª©
    page_icon="ğŸ“š",  # í˜ì´ì§€ ì•„ì´ì½˜
    layout="wide"  # í˜ì´ì§€ ë ˆì´ì•„ì›ƒì„ ì™€ì´ë“œ ëª¨ë“œë¡œ ì„¤ì •
)

# ë©”ì¸ í˜ì´ì§€ ì œëª© ì„¤ì •
st.title("ğŸ“š AI ë…¼ë¬¸ ë¶„ì„ ë„ìš°ë¯¸ with Llama3.2_1b")

# PDF íŒŒì¼ ì—…ë¡œë“œ ìœ„ì ¯ ìƒì„±
uploaded_file = st.file_uploader("ë…¼ë¬¸ PDF íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”", type=['pdf'])

# íŒŒì¼ì´ ì—…ë¡œë“œë˜ë©´ ì‹¤í–‰ë˜ëŠ” ë¡œì§
if uploaded_file is not None:
    # ì—…ë¡œë“œëœ íŒŒì¼ì„ ì„ì‹œ íŒŒì¼ë¡œ ì €ì¥
    with tempfile.NamedTemporaryFile(delete=False, suffix='.pdf') as tmp_file:
        tmp_file.write(uploaded_file.getvalue())
        temp_path = tmp_file.name  # ì„ì‹œ íŒŒì¼ ê²½ë¡œ ì €ì¥

    try:
        # PDF íŒŒì¼ ë¡œë“œ ë° í…ìŠ¤íŠ¸ ì¶”ì¶œ
        loader = PyPDFLoader(temp_path)
        pages = loader.load()  # PDFì˜ ê° í˜ì´ì§€ë¥¼ ë¡œë“œ

        # ì¶”ì¶œëœ í…ìŠ¤íŠ¸ë¥¼ ì‘ì€ ì²­í¬ë¡œ ë¶„í• 
        text_splitter = RecursiveCharacterTextSplitter(
            chunk_size=1000,  # ê° ì²­í¬ì˜ ìµœëŒ€ ë¬¸ì ìˆ˜
            chunk_overlap=200  # ì²­í¬ ê°„ ì¤‘ë³µë˜ëŠ” ë¬¸ì ìˆ˜ (ë¬¸ë§¥ ìœ ì§€ë¥¼ ìœ„í•¨)
        )
        splits = text_splitter.split_documents(pages)

        # í…ìŠ¤íŠ¸ ì„ë² ë”© ì„¤ì •
        embeddings = OllamaEmbeddings(
            model="nomic-embed-text",  # ì„ë² ë”©ì— ì‚¬ìš©í•  ëª¨ë¸
            base_url="http://localhost:11434"  # Ollama ì„œë²„ URL
        )
        
        # ë²¡í„° ì €ì¥ì†Œ ì„¤ì • ë° ë¬¸ì„œ ì €ì¥
        vectorstore = Chroma.from_documents(
            documents=splits,  # ë¶„í• ëœ ë¬¸ì„œ
            embedding=embeddings,  # ì„ë² ë”© í•¨ìˆ˜
            persist_directory="./.chroma"  # ë²¡í„° ì €ì¥ì†Œ ìœ„ì¹˜
        )

        # LLM(ëŒ€ê·œëª¨ ì–¸ì–´ ëª¨ë¸) ì„¤ì •
        llm = Ollama(
            model="llama3.2:1b",  # ì‚¬ìš©í•  LLM ëª¨ë¸
            temperature=0,  # ì‘ë‹µì˜ ì°½ì˜ì„± ì •ë„ (0: ê°€ì¥ ê²°ì •ì )
            base_url="http://localhost:11434"  # Ollama ì„œë²„ URL
        )

        # ì§ˆì˜ì‘ë‹µ ì²´ì¸ ìƒì„±
        qa_chain = RetrievalQA.from_chain_type(
            llm=llm,  # ì‚¬ìš©í•  LLM
            chain_type="stuff",  # QA ì²´ì¸ íƒ€ì…
            retriever=vectorstore.as_retriever()  # ë¬¸ì„œ ê²€ìƒ‰ê¸°
        )

        # ì‚¬ìš©ì ì§ˆë¬¸ ì…ë ¥ ë°›ê¸°
        user_question = st.text_input("ë…¼ë¬¸ì— ëŒ€í•´ ì§ˆë¬¸í•´ë³´ì„¸ìš”:")
        
        # ì§ˆë¬¸ì´ ì…ë ¥ë˜ë©´ ì‹¤í–‰
        if user_question:
            # ì‹œì‘ ì‹œê°„ ê¸°ë¡
            start_time = time.time()
            
            with st.spinner('ë‹µë³€ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...'):  # ë¡œë”© í‘œì‹œ
                # ì§„í–‰ ìƒíƒœ í‘œì‹œ
                progress_placeholder = st.empty()
                progress_placeholder.text("ë‹µë³€ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...")
                
                # ì§ˆë¬¸ì— ëŒ€í•œ ë‹µë³€ ìƒì„±
                response = qa_chain.invoke({"query": user_question})
                
                # ì¢…ë£Œ ì‹œê°„ ê¸°ë¡ ë° ì†Œìš” ì‹œê°„ ê³„ì‚°
                end_time = time.time()
                elapsed_time = round(end_time - start_time, 2)
                
                # ì§„í–‰ ìƒíƒœ í…ìŠ¤íŠ¸ ì œê±°
                progress_placeholder.empty()
                
                # ë‹µë³€ ë° ì†Œìš” ì‹œê°„ í‘œì‹œ
                st.write("ë‹µë³€:")
                st.write(response['result'])
                st.info(f"â±ï¸ ë‹µë³€ ìƒì„± ì†Œìš” ì‹œê°„: {elapsed_time}ì´ˆ")

    finally:
        # ì²˜ë¦¬ ì™„ë£Œ í›„ ì„ì‹œ íŒŒì¼ ì‚­ì œ
        os.unlink(temp_path)

# ì‚¬ì´ë“œë°”ì— ì‚¬ìš© ì„¤ëª… ì¶”ê°€
with st.sidebar:
    st.header("ì‚¬ìš© ë°©ë²•")
    st.write("""
    1. PDF ë…¼ë¬¸ íŒŒì¼ì„ ì—…ë¡œë“œí•©ë‹ˆë‹¤.
    2. ë…¼ë¬¸ì— ëŒ€í•´ ê¶ê¸ˆí•œ ì ì„ ì§ˆë¬¸í•©ë‹ˆë‹¤.
    3. AIê°€ ë…¼ë¬¸ì„ ë¶„ì„í•˜ì—¬ ë‹µë³€ì„ ì œê³µí•©ë‹ˆë‹¤.
    """)